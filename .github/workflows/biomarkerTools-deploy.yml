name: Deploy BiomarkerTools
on:
  workflow_dispatch:
    inputs:
      tier:
        description: "Deploy environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - stage
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  deploy-fargate:
    runs-on: ubuntu-latest
    environment: ${{ inputs.tier }}
    env:
      APP: biomarkerTools
      TZ: America/New_York
      AWS_REGION: us-east-1
      TASK_DEFINITION_TEMPLATE_PATH: .github/aws
      BACKEND_CONTAINER_PORT: 8160
      TIER: ${{ inputs.tier }}
      IMAGE_TIER: ${{ contains(fromJson('["dev","qa"]'), inputs.tier) && 'development' || 'release' }}
      CICD_ROLE_ARN: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-cicd

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ env.CICD_ROLE_ARN }}
          role-session-name: ${{ env.TIER }}-${{ env.APP }}-deploy-${{ github.ref_name }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set dynamic environment variables
        run: |
          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          REPO=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.$AWS_REGION.amazonaws.com/$APP
          
          echo "IMAGE_REPOSITORY=$REPO" >> $GITHUB_ENV
          echo "BACKEND_IMAGE=$REPO:$IMAGE_TIER-backend-${{ github.ref_name }}-$TIMESTAMP" >> $GITHUB_ENV
          echo "BACKEND_IMAGE_LATEST=$REPO:$IMAGE_TIER-backend-${{ github.ref_name }}-latest" >> $GITHUB_ENV
          echo "PARAMETER_PATH=/analysistools/${TIER}/${APP}" >> $GITHUB_ENV
          echo "ENVIRONMENT_TIER=${TIER^^}" >> $GITHUB_ENV

      - name: Retrieve SSM parameters
        run: |
          PARAMETER_PATH="/analysistools/${TIER}/${APP}"
          
          declare -A PARAMS=(
            ["ecs_cluster"]="ECS_CLUSTER"
            ["ecs_web_task"]="ECS_WEB_TASK"
            ["ecs_web_service"]="ECS_WEB_SERVICE"
            ["ecs_cpu_units"]="ECS_CPU_UNITS"
            ["ecs_memory_units"]="ECS_MEMORY_UNITS"
            ["role_arn"]="ROLE_ARN"
            ["efs_filesystem_id"]="EFS_FILESYSTEM_ID"
            ["efs_access_point_id"]="EFS_ACCESS_POINT_ID"
          )
          
          for ssm_name in "${!PARAMS[@]}"; do
            env_var="${PARAMS[$ssm_name]}"
            value=$(aws ssm get-parameter \
              --name "${PARAMETER_PATH}/${ssm_name}" \
              --with-decryption \
              --query "Parameter.Value" \
              --output text)
            echo "${env_var}=${value}" >> $GITHUB_ENV
            echo "Retrieved ${ssm_name} -> ${env_var}"
          done

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2.0.1
        with:
          mask-password: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Build and push backend image
        uses: docker/build-push-action@v6.18.0
        with:
          context: biomarkerTools
          file: biomarkerTools/docker/backend.dockerfile
          pull: true
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}
            ${{ env.BACKEND_IMAGE_LATEST }}
          cache-from: type=registry,ref=${{ env.IMAGE_REPOSITORY }}:backend-cache
          cache-to: type=registry,ref=${{ env.IMAGE_REPOSITORY }}:backend-cache,mode=max

      - name: Render task definition
        run: |
          envsubst < $TASK_DEFINITION_TEMPLATE_PATH/web.yml > web.yml
          echo "Rendered Task Definition:"
          cat web.yml

      - name: Register task definition
        run: |
          aws ecs register-task-definition --cli-input-yaml file://web.yml

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_WEB_SERVICE }} \
            --task-definition ${{ env.ECS_WEB_TASK }} \
            --desired-count 1 \
            --propagate-tags TASK_DEFINITION \
            --force-new-deployment

      - name: Wait for service stability
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_WEB_SERVICE }}

      - name: Remove old task definitions
        run: |
          echo "Pruning old revisions for family: $ECS_WEB_TASK"
          aws ecs list-task-definitions \
            --family-prefix "$ECS_WEB_TASK" \
            --sort DESC \
            --query 'taskDefinitionArns[3:]' \
            --output text \
          | xargs -n1 -r aws ecs deregister-task-definition --task-definition
